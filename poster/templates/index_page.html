{% extends "templates/base_vote.html" %}

{% block js %}
{{ super() }}

<script>
function upvotePost(postId) {
	const upvotePath = document.getElementsByName("upvote_path-" + postId)[0].value;
	fetch(upvotePath)
		.then(response => response.json())
		.then(postData => {
			const url = getUrl();
			const card = document.getElementById("card-" + postData.post.id);
			const postHTML = renderPost(postData, url);
			card.innerHTML = postHTML;
		})
		.catch(error => console.log(error));
}
function downvotePost(postId) {
	const downvotePath = document.getElementsByName("downvote_path-" + postId)[0].value;
	fetch(downvotePath)
		.then(response => response.json())
		.then(postData => {
			const url = getUrl();
			const card = document.getElementById("card-" + postData.post.id);
			const postHTML = renderPost(postData, url);
			card.innerHTML = postHTML;
		})
		.catch(error => console.log(error));
}


function getUrl() {
	let url = new URL(window.location.href) + "/";
    if (url.endsWith("//")) {
		url = url.slice(0, -1);
	}
    return url;
}
async function getPostDataJson(url) {
	const response = await fetch(url + "get_posts");
	const data = await response.json();
	return data;
}
async function renderPostDataJsons() {
	let url = getUrl();

	const contentContainer = document.getElementById("contentContainer");

	const postDatas = await getPostDataJson(url);
	for (let postData of postDatas) {
		const card = document.createElement("div");
		card.id = "card-" + postData.post.id;
		card.className = "card box-shadow mx-4 mb-4 mt-0";

		const postHTML = renderPost(postData, url);
		card.innerHTML = postHTML;		
		
		contentContainer.appendChild(card);
	}
	
}
function renderPost(post_data, basePath) {
	let output = ``;
	output += `
 
	<h5 class="card-header">${ post_data.post.title }</h5>
	
	<input type="hidden" name="upvote_path-${ post_data.post.id }" value="${ basePath + 'upvote_post/' + post_data.post.id }" readonly>
	<input type="hidden" name="downvote_path-${ post_data.post.id }" value="${ basePath + 'downvote_post/' + post_data.post.id }" readonly>

	<div class="card-body">
		<h5 class="card-title text-muted">${ post_data.account.display_name }</h5>

		<p class="card-text">${ post_data.post.content }</p>

		<p class="card-text text-muted my-0">${ post_data.comment_count } comments</p>
		<p id="score-${ post_data.post.id }" class="card-text text-muted my-0">${ post_data.post.score } upvotes</p>
        <p class="card-text text-muted">${ post_data.date_string }</p>
	`;

	if (post_data.vote_value == -2) {
		output += `	<button onclick="upvotePost(${ post_data.post.id });" class="btn btn-sm btn-outline-success mb-2" disabled>Upvote</button>
					<button onclick="downvotePost(${ post_data.post.id });" class="btn btn-sm btn-outline-danger mb-2" disabled>Downvote</button>`
	} else if (post_data.vote_value == -1) {
		output += `	<button onclick="upvotePost(${ post_data.post.id });" class="btn btn-sm btn-outline-success mb-2">Upvote</button>
					<button onclick="downvotePost(${ post_data.post.id });" class="btn btn-sm btn-danger mb-2">Downvote</button>`
	} else if (post_data.vote_value == 1) {
		output += `	<button onclick="upvotePost(${ post_data.post.id });" class="btn btn-sm btn-success mb-2">Upvote</button>
					<button onclick="downvotePost(${ post_data.post.id });" class="btn btn-sm btn-outline-danger mb-2">Downvote</button>`
	} else {
		output += `	<button onclick="upvotePost(${ post_data.post.id });" class="btn btn-sm btn-outline-success mb-2">Upvote</button>
					<button onclick="downvotePost(${ post_data.post.id });" class="btn btn-sm btn-outline-danger mb-2">Downvote</button>`
	}
		
	output += `
		<br />

		<a href="${ basePath + 'post/' + post_data.post.id }" class="btn btn-primary">View Post</a>
	</div>

	`

	return output;
}


var throttleTimer;
const throttle = (callback, time) => {
  if (throttleTimer) return;
  throttleTimer = true;
  setTimeout(() => {
	callback();
    throttleTimer = false;
  }, time);
}
const handleInfiniteScroll = () => {
  throttle(() => {
    const endOfMessagesWarning = document.getElementById("endOfMessagesWarning");
    const height = endOfMessagesWarning.getBoundingClientRect().bottom - endOfMessagesWarning.getBoundingClientRect().top;
    const endOfPage = window.innerHeight + window.pageYOffset >= document.body.offsetHeight - 5 - height;
    if (endOfPage) {
		renderPostDataJsons()
            .then(() => {
                window.scrollBy({
                    top: 100,
                    left: 0,
                    behavior: 'smooth'
                });
            })
    }
  }, 500);
};


var lastSort = "newest";
function radioButtonOnclick() {
    const radioButtons = document.getElementsByName("options");
    for (let radioButton of radioButtons) {
        radioButton.addEventListener("click", async function() {
            if (lastSort != radioButton.id) {
                lastSort = radioButton.id;
                fetch(getUrl() + "set_sort/" + radioButton.id)
                    .then((_response) => {
                        const contentContainer = document.getElementById("contentContainer");
                        contentContainer.innerHTML = "";
                        renderPostDataJsons();
                    });
            }
        });
    }

}



document.addEventListener("DOMContentLoaded", () => {
    radioButtonOnclick();
	renderPostDataJsons();

	const sort = document.getElementById("sort-value");
	const radioButtons = document.getElementsByName("options");
	for (let radioButton of radioButtons) {
		if (radioButton.id == sort.value) {
			radioButton.checked = true;
			lastSort = sort.value;
		} else {
			radioButton.checked = false;
		}
	}
});
window.addEventListener("scroll", handleInfiniteScroll);
</script>

{% endblock %}



{% block body %}

	<input id="sort-value" name="sort-value" type="hidden" value="{{ sort }}" />
  
	<div class="row justify-content-center full-width">
    	<div class="col-12 col-sm-11 col-md-9 col-lg-7 col-xl-6">

            <div class="btn-group btn-group-toggle px-4 mb-2" data-toggle="buttons">
                <label class="btn btn-secondary">
                    <input type="radio" name="options" id="newest">Newest
                </label>
                <label class="btn btn-secondary">
                    <input type="radio" name="options" id="top-all-time">Top: all time
                </label>
                <label class="btn btn-secondary">
                    <input type="radio" name="options" id="top-this-year">Top: this year
                </label>
                <label class="btn btn-secondary">
                    <input type="radio" name="options" id="top-this-week">Top: this week
                </label>
                <label class="btn btn-secondary">
                    <input type="radio" name="options" id="top-today">Top: today
                </label>
            </div>


            <div id="contentContainer"></div>


            <div id="endOfMessagesWarning" class="card box-shadow m-4">
                <h5 class="card-header">You have seen all the posts there are to see...</h5>
                <div class="card-body justify-content-center">
                    <button onclick="" class="btn btn-sm btn-outline-primary mb-2">Reset seen posts</button>
                </div>
            </div>

        </div>

        
	</div>
{% endblock %}